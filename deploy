#!/bin/sh

ssh blackbook "
  cd ~/blackbook4/
  git pull origin master
  ruby --version
  cd /home/rails/.rbenv/plugins/ruby-build && git pull && cd -
  rbenv install $(cat .ruby-version)
  echo 'Bundle install...'
  /home/rails/.rbenv/shims/bundle install
  echo 'Running migrations...'
  RAILS_ENV=production /home/rails/.rbenv/shims/rake db:migrate
  echo 'Compiling assets...'
  RAILS_ENV=production /home/rails/.rbenv/shims/rake assets:precompile
  touch tmp/restart.txt
  echo 'Restarting service...'
  sudo systemctl restart blackbook4
  echo 'All done'
"

curl -sL -w "%{http_code}" http://000000book.com -o /dev/null; echo
sleep 1
curl -sL -w "%{http_code}" http://000000book.com -o /dev/null; echo
sleep 1
curl -sL -w "%{http_code}" http://000000book.com -o /dev/null; echo
sleep 1
curl -sL -w "%{http_code}" http://000000book.com -o /dev/null; echo
sleep 1
curl -sL -w "%{http_code}" http://000000book.com -o /dev/null; echo
